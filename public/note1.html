<!DOCTYPE html>
<html lang="en">

<head>
  <script src="javascript/libs/p5.js"></script>
  <script src="javascript/libs/addons/p5.sound.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <!-- <script src="../node_modules/socket.io/client-dist/socket.io.js"></script>   -->
  <!-- <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script> -->

  <link rel="stylesheet" type="text/css" href="style.css">
  <meta charset="utf-8">
  <!--  -->
</head>

<body>
  <main>
    <p>440</p>
  </main>

  <script>
    const socket = io();

    let osc;
    let context;

    let volumes = [];

    const number_of_voices = 3;

    const assignedMirror = '1'

    const harmonicsArray = [1, 1.33, 1.779, 5, 7];
    let freqCarr = 330;

    function setup() {
      // frameRate(60);

      // mimics the autoplay policy
      getAudioContext().suspend();

      createCanvas(500, 500);
      osc = new p5.Oscillator();
      osc.freq(440);
      osc.setType('sine');
      osc.amp(0.5);
      osc.start();

      mic = new p5.AudioIn();
      mic.start();
      fft = new p5.FFT();
      fft.setInput(mic);
    }

    function draw() {

      background(240, 0, 0);

      fft.analyze();
      for (let i = 0; i < number_of_voices; i++) {
        volumes[i] = fft.getEnergy(freqCarr * harmonicsArray[i], freqCarr * harmonicsArray[i]);
      }

      const initY = 50;
      const offsetY = 30;

      const maxWidth = 100;
      const xVueMeters = 180;

      for (let i = 0; i < number_of_voices; i++) {
        const y = initY + offsetY * i
        fill(255);
        textSize(24)
        textAlign(LEFT, TOP);
        text(int(freqCarr * harmonicsArray[i]) + ' Hz: ' + volumes[i], 50, y);
        stroke(0);
        noFill();
        rect(xVueMeters, y, maxWidth, 20);
        fill(0);
        rect(xVueMeters, y, map(volumes[i], 0, 255, 0, maxWidth), 20);
      }
      emit();

      let waveform = fft.waveform(); // analyze the waveform

      let reduced = [];
      beginShape();
      strokeWeight(5);
      for (let i = 0; i < waveform.length; i += 16) {
        let x = map(i, 0, waveform.length, 0, width);
        let y = map(waveform[i], -1, 1, height, 0);
        vertex(x, y);
        reduced.push(waveform[i]);
      }
      endShape();

      socket.emit("waveform", {
        assignedMirror: assignedMirror,
        waveform: /* waveform */ reduced
      })

    }

    function mousePressed() {
      userStartAudio();
    }

    function emit() {

      let arrayValObj = [];

      for (let i = 0; i < number_of_voices; i++) {
        arrayValObj.push(volumes[i])
      }

      socket.emit("data", {
        address: "/mobileData/" + assignedMirror,
        args: arrayValObj
      })
    }

    //Events that we are listening for
    // Connect to Node.JS Server
    socket.on("connect", () => {
      console.log(socket.id, 'assignedMirror: ', assignedMirror);
      myId = socket.id;

      socket.emit("identification", [true, myId, assignedMirror]);
    });

    // Callback function on the event we disconnect
    socket.on("disconnect", () => {
      console.log(socket.id);
    });
  </script>

</body>

</html>